#PostgreSQL前后端协议

##1.概述

PostgreSQL前后端的协议分两阶段：启动阶段和正常操作阶段。启动阶段，前端打开与服务端的连接并且认证自身满足服务端的要求（包括一个还是多个信息取决于采用的认证方式）。如果所有的都顺利，服务端发送一个状态信息给前端，并最后进入正常操作阶段。除了启动阶段的请求信息，这个协议的部分是受服务端驱动的。

在正常操作阶段，前端发送查询和其他命令给后端，后端发回查询结果和其他响应。有些特例（例如通知NOTIFY），后端会发送飞请求的消息，这个会话的大部分是由前端请求驱动的。

会话的结束正常情况下是由前端选择的，但在某些情况下可以被后端强制结束。任何情况下，后端关闭连接后，它都会在退出前回滚未完成的打开的事务。

正常操作阶段，SQL命令能够通过两个子协议之一执行。简单查询协议中，前端只发送文本查询字符串，查询将被后端解析并立即执行。在"extended query"中，语句的处理将被分为多步：解析，绑定参数值和执行。这提供了灵活性和性能提升，在额外的复杂成本上。

正常操作阶段对一些特殊的操作例如：copy，有额外的子协议。

##2.休息概述

所有的通讯都是通过消息流传递。消息的第一个字节标识了消息的类型，接下来的四个字节指定了余下的消息内容的长度（不包括消息的类型，但包括了消息的长度本身的4个字节）。其余的消息内容是由消息的类型决定的，因为历史的原因，客户端最开始发送的消息（the startup message)没有消息类型。

为了避免丢失消息流的同步，服务端与客户端在尝试处理消息内容前会把整个消息缓存起来。这样在处理消息时检测到错误可以恢复。在极端的情况下（没有足够的内存缓存消息），接收者可以使用字节数决定多少输入被跳过在继续读取消息前。

相反的，服务端与客户端必须避免发送不完整消息。这通常通过把整个消息在内存中组装好来完成。如果在发送或者接收消息的过程中通讯失败，唯一明智的方法就是放弃连接，因为没有任何可以恢复消息边界同步的希望。


##3.扩展查询概述

在扩展查询协议中，SQL命令的执行被分成多步，在每两步之间的状态保存在两种对象中：prepared statements 和 portals。prepared statement代表文本查询字符串解析和语义分析的结果。一个prepared statement自身是不能执行的，因为它可能缺少指定参数的值。一个portal代表准备执行或已经部分执行的语句,任何确实的参数值都补充了。（对于select语句，一个portal是和一个打开的游标，但是我们选择用一个不同的概念，因为游标不处理非select语句）。

整体上执行周期包括一个查询步骤，创建prepared  statement从文本查询字符串中；一个绑定步骤，创建一个portal，在提供了prepared statement和它需要的参数值后；和一个执行步骤执行portal 查询。从语句返回行的方面看，执行步骤可以通过获取有限的行来区别，所以多个执行步骤可能需要完成操作。
（In the case of the query that returns rows(select, show,etc),the execute step can be told to fetch only a limited number of rows, so that multiple execute steps might be needed to complete the operation).

后台可以跟踪多个prepared statements 和portal(但是注意这些存在在一个session内，并且不能跨session共享)。已经存在的prepared statements和portals在创建时被赋予名字。此外一个未命名的prepared statements和portal存在。尽管这些和命名对象很大程度上相同， 但在它们上的操作例如执行一个语句时制备优化一次然后被遗弃，而在命名对象上的操作会被优化多次。


